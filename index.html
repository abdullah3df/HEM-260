<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>HE Cut Pro v8 — بدون تكبير</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');
    html,body{font-family:Cairo,system-ui,ui-sans-serif;}
    svg,svg *{user-select:none}
    body{
      background:
        radial-gradient(circle at top left, rgba(56,189,248,0.2), transparent 55%),
        radial-gradient(circle at bottom right, rgba(129,140,248,0.25), #020617);
      min-height:100vh;
    }
    .glass {
      background: radial-gradient(circle at top, rgba(148,163,184,0.18), rgba(15,23,42,0.9));
      backdrop-filter: blur(18px);
    }
    input[type="range"] {
      -webkit-appearance:none;appearance:none;width:100%;height:0.5rem;border-radius:999px;background:#020617;outline:none;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance:none;appearance:none;width:18px;height:18px;border-radius:999px;background:#38bdf8;border:2px solid #0f172a;box-shadow:0 0 0 4px rgba(56,189,248,0.4);cursor:pointer;margin-top:-4px;
    }
    input[type="range"]::-moz-range-thumb {
      width:18px;height:18px;border-radius:999px;background:#38bdf8;border:2px solid #0f172a;box-shadow:0 0 0 4px rgba(56,189,248,0.4);cursor:pointer;
    }
    input[type="range"]::-moz-range-track {
      background:#020617;height:0.5rem;border-radius:999px;
    }
    .cursor-help {
      position: relative;
    }
    .cursor-help:hover::after {
      content: attr(title);
      position: absolute;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      background: #0f172a;
      color: #e2e8f0;
      padding: 4px 8px;
      border-radius: 6px;
      white-space: nowrap;
      font-size: 10px;
      pointer-events: none;
      z-index: 10;
      border: 1px solid #38bdf8;
    }
  </style>
</head>
<body class="text-slate-100">

  <!-- شريط علوي -->
  <header class="border-b border-slate-800/60 bg-slate-900/80 backdrop-blur sticky top-0 z-20">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
      <div>
        <h1 class="text-xl sm:text-2xl font-bold tracking-tight">
          HE Cut Pro <span class="text-sky-400 text-base align-middle">v8</span>
        </h1>
        <p class="text-xs sm:text-sm text-slate-400 mt-0.5">
          قص الجناح العلوي والسفلي — ميلان حر لكل جناح
        </p>
      </div>
      <div class="text-[10px] sm:text-xs text-slate-300 text-left leading-snug" id="modeLabel">
        وضع الحساب: من الزاوية → القص
      </div>
    </div>
  </header>

  <!-- المحتوى الرئيسي -->
  <main class="max-w-6xl mx-auto px-4 py-6 sm:py-10 grid grid-cols-1 lg:grid-cols-[minmax(0,1.1fr)_minmax(0,1.1fr)] gap-6">
    <!-- لوحة الإعدادات -->
    <section class="glass rounded-2xl shadow-xl shadow-sky-950/50 border border-slate-700/70 p-4 sm:p-5">
      <div class="flex items-center justify-between gap-2 mb-4">
        <h2 class="font-semibold text-lg sm:text-xl flex items-center gap-2">
          <span class="inline-flex h-6 w-6 rounded-full bg-sky-500/20 border border-sky-400/50 items-center justify-center text-[11px]">1</span>
          الإعدادات &amp; الحساب
        </h2>
      </div>

      <div class="grid grid-cols-2 gap-3 text-sm">
        <!-- سلسلة -->
        <label class="col-span-2 text-slate-300 flex items-center justify-between">
          سلسلة المقطع
          <span class="text-[10px] text-sky-300/80">HEA / HEB / HEM</span>
        </label>
        <select id="series" class="col-span-2 rounded-lg border border-slate-700 bg-slate-900/70 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-sky-400">
          <option value="HEA">HEA</option>
          <option value="HEB" selected>HEB</option>
          <option value="HEM">HEM</option>
        </select>

        <!-- مقاس -->
        <label class="col-span-2 text-slate-300 flex items-center justify-between mt-1">
          المقاس
          <span class="text-[10px] text-slate-400">HE 100 … HE 400</span>
        </label>
        <select id="size" class="col-span-2 rounded-lg border border-slate-700 bg-slate-900/70 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-sky-400"></select>

        <!-- اختيار الأجنحة -->
        <label class="col-span-2 text-slate-300 flex items-center justify-between mt-1">
          الأجنحة المراد قصّها
          <span class="text-[10px] text-slate-400">يؤثر على توزيع القص والرسم</span>
        </label>
        <div class="col-span-2 flex flex-wrap gap-3 text-xs text-slate-200">
          <label class="inline-flex items-center gap-1">
            <input type="radio" name="cutWings" value="both" checked class="text-sky-400 focus:ring-sky-500">
            <span>الجناحان</span>
          </label>
          <label class="inline-flex items-center gap-1">
            <input type="radio" name="cutWings" value="top" class="text-sky-400 focus:ring-sky-500">
            <span>العلوي فقط</span>
          </label>
          <label class="inline-flex items-center gap-1">
            <input type="radio" name="cutWings" value="bottom" class="text-sky-400 focus:ring-sky-500">
            <span>السفلي فقط</span>
          </label>
        </div>

        <!-- زاوية التجميع -->
        <label class="col-span-2 text-slate-300 flex items-center justify-between mt-1">
          زاوية التجميع θ (درجة)
        </label>
        <div class="col-span-2 flex items-center gap-3">
          <input id="angleRange" type="range" min="1" max="45" step="0.5" value="30"/>
          <div class="flex items-center gap-1 text-xs text-slate-200">
            <input id="angle" type="number" min="1" max="45" step="0.5" value="30"
                   class="w-16 rounded-lg border border-slate-700 bg-slate-900/80 px-2 py-1 focus:outline-none focus:ring-1 focus:ring-sky-400 text-center"/>
            <span>°</span>
          </div>
        </div>

        <!-- قص الجناح (لكل قطعة) -->
        <label class="col-span-2 text-slate-300 flex items-center justify-between mt-1">
          قص الجناح (لكل قطعة) mm
        </label>
        <div class="col-span-2 grid grid-cols-2 gap-3">
          <!-- علوي -->
          <div>
            <div class="text-xs text-slate-400 mb-1">Δ<sub>top</sub></div>
            <div class="flex flex-col gap-1">
              <input id="deltaTopRange" type="range" min="0" max="100" step="0.1" value="0"/>
              <div class="flex items-center gap-1 text-xs text-slate-200">
                <input id="deltaTop" type="number" min="0" step="0.1" value="0"
                       class="w-full rounded-lg border border-slate-700 bg-slate-900/80 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-emerald-400"/>
              </div>
            </div>
          </div>
          <!-- سفلي -->
          <div>
            <div class="text-xs text-slate-400 mb-1">Δ<sub>bottom</sub></div>
            <div class="flex flex-col gap-1">
              <input id="deltaBottomRange" type="range" min="0" max="100" step="0.1" value="0"/>
              <div class="flex items-center gap-1 text-xs text-slate-200">
                <input id="deltaBottom" type="number" min="0" step="0.1" value="0"
                       class="w-full rounded-lg border border-slate-700 bg-slate-900/80 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-emerald-400"/>
              </div>
            </div>
          </div>
        </div>

        <!-- ميلان حر لكل جناح -->
        <label class="col-span-2 text-slate-300 flex items-center justify-between mt-3">
          ميلان خط القص في الرسم (من العمودي) — <b class="text-amber-300">حر لكل جناح</b>
        </label>

        <!-- ميلان علوي -->
        <div class="col-span-2">
          <div class="flex items-center justify-between text-xs text-slate-400">
            <span>زاوية ميلان الخط العلوي (α<sub>top</sub>)</span>
            <span class="inline-flex items-center gap-1 text-[10px] text-sky-300/80 cursor-help"
                  title="0° = خط عمودي، 30° أو أكثر = خط مائل (للتمثيل البصري فقط)">
              <svg class="w-3 ه-3" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd"
                      d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                      clip-rule="evenodd"/>
              </svg>
            </span>
          </div>
          <div class="flex items-center gap-3 mt-1">
            <input id="alphaTopRange" type="range" min="0" max="60" step="1" value="0"/>
            <div class="flex items-center gap-1 text-xs text-slate-200">
              <input id="alphaTop" type="number" min="0" max="60" step="1" value="0"
                     class="w-14 rounded-lg border border-slate-700 bg-slate-900/80 px-2 py-1 focus:outline-none focus:ring-1 focus:ring-sky-400 text-center"/>
              <span>°</span>
            </div>
          </div>
        </div>

        <!-- ميلان سفلي -->
        <div class="col-span-2">
          <div class="flex items-center justify-between text-xs text-slate-400">
            <span>زاوية ميلان الخط السفلي (α<sub>bottom</sub>)</span>
            <span class="inline-flex items-center gap-1 text-[10px] text-sky-300/80 cursor-help"
                  title="0° = خط عمودي، 30° أو أكثر = خط مائل (للتمثيل البصري فقط)">
              <svg class="w-3 ه-3" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd"
                      d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                      clip-rule="evenodd"/>
              </svg>
            </span>
          </div>
          <div class="flex items-center gap-3 mt-1">
            <input id="alphaBottomRange" type="range" min="0" max="60" step="1" value="0"/>
            <div class="flex items-center gap-1 text-xs text-slate-200">
              <input id="alphaBottom" type="number" min="0" max="60" step="1" value="0"
                     class="w-14 rounded-lg border border-slate-700 bg-slate-900/80 px-2 py-1 focus:outline-none focus:ring-1 focus:ring-sky-400 text-center"/>
              <span>°</span>
            </div>
          </div>
        </div>

        <!-- اتجاه الميلان لكل جناح -->
        <label class="col-span-2 text-slate-300 flex items-center justify-between mt-2">
          اتجاه الميلان
          <span class="text-[10px] text-slate-400">مرّر للتوضيح</span>
        </label>
        <div class="col-span-2 grid grid-cols-2 gap-3 text-xs text-slate-200">
          <div>
            <div class="mb-1 text-slate-400">اتجاه ميلان العلوي</div>
            <div class="flex gap-2">
              <label class="inline-flex items-center gap-1">
                <input type="radio" name="tiltDirTop" value="in" checked class="text-sky-400 focus:ring-sky-500">
                <span>نحو الوسط</span>
              </label>
              <label class="inline-flex items-center gap-1">
                <input type="radio" name="tiltDirTop" value="out" class="text-sky-400 focus:ring-sky-500">
                <span>خارج</span>
              </label>
            </div>
          </div>
          <div>
            <div class="mb-1 text-slate-400">اتجاه ميلان السفلي</div>
            <div class="flex gap-2">
              <label class="inline-flex items-center gap-1">
                <input type="radio" name="tiltDirBottom" value="in" checked class="text-emerald-400 focus:ring-emerald-500">
                <span>نحو الوسط</span>
              </label>
              <label class="inline-flex items-center gap-1">
                <input type="radio" name="tiltDirBottom" value="out" class="text-emerald-400 focus:ring-emerald-500">
                <span>خارج</span>
              </label>
            </div>
          </div>
        </div>

      </div>

      <!-- نتائج نصية -->
      <div class="mt-5 rounded-xl border border-slate-700/80 bg-slate-900/70 px-3.5 py-3 text-sm" id="readout"></div>

      <div class="mt-4 flex flex-wrap gap-2">
        <button id="btnReset" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-xs sm:text-sm border border-slate-600">
          إعادة الضبط
        </button>
      </div>

      <p class="text-[11px] text-slate-400 mt-3 leading-relaxed">
        <b>ملاحظات:</b><br>
        • الزوايا α<sub>top</sub> و α<sub>bottom</sub> + اتجاهيهما المستقل يتحكم فقط في <b>شكل الخط الأحمر في الرسم</b> ولا يغيّر الحسابات الهندسية للقص.<br>
        • الوجه الأمامي والخلفي للقطعة مفهومان هنا أن لهما نفس شكل القص.
      </p>
    </section>

    <!-- الشكل الأمامي -->
    <section class="glass rounded-2xl shadow-xl shadow-sky-950/50 border border-slate-700/70 p-4 sm:p-5 flex flex-col">
      <div class="flex items-center justify-between gap-2 mb-4">
        <h2 class="font-semibold text-lg sm:text-xl flex items-center gap-2">
          <span class="inline-flex h-6 w-6 rounded-full bg-emerald-500/20 border border-emerald-400/60 items-center justify-center text-[11px]">2</span>
          الوجه الأمامي — ميلان حر لكل جناح
        </h2>
      </div>

      <div class="flex-1 border border-slate-700/70 rounded-2xl bg-slate-900/70 px-3 py-4 flex items-center justify-center">
        <div id="frontWrapper"></div>
      </div>

      <div class="grid grid-cols-2 gap-3 text-[11px] text-slate-400 mt-4">
        <div class="flex items-center gap-2"><span class="inline-block h-3 w-3 rounded-sm bg-slate-400/80"></span>الجناحان (علوي / سفلي)</div>
        <div class="flex items-center gap-2"><span class="inline-block h-3 w-3 rounded-sm bg-slate-300"></span>العمود (web)</div>
        <div class="flex items-center gap-2"><span class="inline-block h-3 w-3 rounded-sm bg-red-500"></span>خطوط القص (عمودية أو مائلة) حسب إعداداتك</div>
        <div class="flex items-center gap-2"><span class="inline-block h-3 w-3 rounded-full border border-sky-400"></span>الرسم تمثيلي — الأبعاد الرقمية هي المرجع</div>
      </div>
    </section>

  </main>

  <footer class="max-w-6xl mx-auto px-4 pb-6 text-[11px] text-slate-500 flex flex-wrap items-center justify-between gap-2">
    <span>HE Cut Pro v8 — بدون تكبير</span>
    <span>للتنفيذ العملي: اعتمد كتالوج المقاطع وتعليمات الورشة.</span>
  </footer>

  <!-- المنطق -->
  <script>
    const HE_DATA = {
      HEA: {100:{b:100},120:{b:120},140:{b:140},160:{b:160},180:{b:180},200:{b:200},220:{b:220},240:{b:240},260:{b:260},280:{b:280},300:{b:300},320:{b:300},340:{b:300},360:{b:300},400:{b:300}},
      HEB: {100:{b:100},120:{b:120},140:{b:140},160:{b:160},180:{b:180},200:{b:200},220:{b:220},240:{b:240},260:{b:260},280:{b:280},300:{b:300},320:{b:300},340:{b:300},360:{b:300},400:{b:300}},
      HEM: {100:{b:120},120:{b:120},140:{b:140},160:{b:160},180:{b:180},200:{b:200},220:{b:220},240:{b:240},260:{b:260},280:{b:260},300:{b:300},320:{b:300},340:{b:300},360:{b:300},400:{b:300}}
    };
    const CALIB = 0.9596893820706635;

    const $series = document.getElementById('series');
    const $size   = document.getElementById('size');
    const $angle  = document.getElementById('angle');
    const $angleRange = document.getElementById('angleRange');
    const $deltaTop = document.getElementById('deltaTop');
    const $deltaBottom = document.getElementById('deltaBottom');
    const $deltaTopRange = document.getElementById('deltaTopRange');
    const $deltaBottomRange = document.getElementById('deltaBottomRange');
    const $alphaTop = document.getElementById('alphaTop');
    const $alphaTopRange = document.getElementById('alphaTopRange');
    const $alphaBottom = document.getElementById('alphaBottom');
    const $alphaBottomRange = document.getElementById('alphaBottomRange');
    const $readout= document.getElementById('readout');
    const $frontWrapper = document.getElementById('frontWrapper');
    const $btnReset = document.getElementById('btnReset');
    const $modeLabel = document.getElementById('modeLabel');
    const $cutWingsRadios = document.querySelectorAll('input[name="cutWings"]');

    let mode = 'angle';
    let cutMode = 'both';

    function getCutMode() {
      const checked = document.querySelector('input[name="cutWings"]:checked');
      return checked ? checked.value : 'both';
    }
    function getTiltDirTop() {
      const checked = document.querySelector('input[name="tiltDirTop"]:checked');
      return checked ? checked.value : 'in';
    }
    function getTiltDirBottom() {
      const checked = document.querySelector('input[name="tiltDirBottom"]:checked');
      return checked ? checked.value : 'in';
    }

    function populateSizes() {
      const s = $series.value;
      const sizes = Object.keys(HE_DATA[s]).map(Number).sort((a,b)=>a-b);
      $size.innerHTML = sizes
        .map(v => `<option value="${v}" ${v===180?'selected':''}>${v}</option>`)
        .join('');
    }

    function updateDeltaRangesMax(b) {
      const maxVal = Math.max(20, Math.round(b / 2)); // نصف عرض الجناح تقريباً
      $deltaTopRange.max = maxVal;
      $deltaBottomRange.max = maxVal;
    }

    function calc() {
      const s   = $series.value;
      const sz  = Number($size.value);
      cutMode   = getCutMode();
      const tiltDirTop = getTiltDirTop();
      const tiltDirBottom = getTiltDirBottom();

      let angDeg= Number($angle.value);
      const data = HE_DATA[s][sz] || {b:180};
      const b    = data.b;

      updateDeltaRangesMax(b);

      let deltaTop = Number($deltaTop.value);
      let deltaBottom = Number($deltaBottom.value);
      if (isNaN(deltaTop)) deltaTop = 0;
      if (isNaN(deltaBottom)) deltaBottom = 0;

      let alphaTopDeg = Number($alphaTop.value);
      let alphaBottomDeg = Number($alphaBottom.value);
      if (isNaN(alphaTopDeg)) alphaTopDeg = 0;
      if (isNaN(alphaBottomDeg)) alphaBottomDeg = 0;
      alphaTopDeg = Math.max(0, Math.min(60, alphaTopDeg));
      alphaBottomDeg = Math.max(0, Math.min(60, alphaBottomDeg));
      $alphaTop.value = alphaTopDeg.toFixed(0);
      $alphaTopRange.value = alphaTopDeg;
      $alphaBottom.value = alphaBottomDeg.toFixed(0);
      $alphaBottomRange.value = alphaBottomDeg;

      if (mode === 'angle') {
        if (!isFinite(angDeg) || angDeg < 1) angDeg = 1;
        if (angDeg > 45) angDeg = 45;
        const theta = angDeg * Math.PI / 180;
        const deltaEachBase = b * Math.tan(theta) / 2;
        const deltaEach = deltaEachBase * CALIB;

        if (cutMode === 'both') {
          deltaTop = deltaEach;
          deltaBottom = deltaEach;
        } else if (cutMode === 'top') {
          deltaTop = deltaEach;
          deltaBottom = 0;
        } else if (cutMode === 'bottom') {
          deltaTop = 0;
          deltaBottom = deltaEach;
        }
      } else {
        let sumTheta = 0; let count = 0; let thetaTop = 0, thetaBottom = 0;
        if (deltaTop > 0.0001) { thetaTop = Math.atan((deltaTop / CALIB) * 2 / b); sumTheta += thetaTop; count++; }
        if (deltaBottom > 0.0001) { thetaBottom = Math.atan((deltaBottom / CALIB) * 2 / b); sumTheta += thetaBottom; count++; }
        let thetaDisplay = 0;
        if (count > 0) thetaDisplay = sumTheta / count;
        angDeg = thetaDisplay * 180 / Math.PI;
        if (!isFinite(angDeg) || angDeg < 0) angDeg = 0;
        if (angDeg > 60) angDeg = 60;
      }

      // sync sliders
      $angle.value = angDeg.toFixed(1);
      $angleRange.value = angDeg;
      $deltaTop.value = deltaTop.toFixed(2);
      $deltaBottom.value = deltaBottom.toFixed(2);
      $deltaTopRange.value = deltaTop;
      $deltaBottomRange.value = deltaBottom;

      const thetaTop = deltaTop > 0.0001 ? Math.atan((deltaTop / CALIB) * 2 / b) : 0;
      const thetaBottom = deltaBottom > 0.0001 ? Math.atan((deltaBottom / CALIB) * 2 / b) : 0;
      const angleTopDeg = thetaTop * 180 / Math.PI;
      const angleBottomDeg = thetaBottom * 180 / Math.PI;
      const remainingTop = Math.max(b - deltaTop, 0);
      const remainingBottom = Math.max(b - deltaBottom, 0);

      renderReadout({
        s, sz, b, angDeg,
        deltaTop, deltaBottom,
        angleTopDeg, angleBottomDeg,
        remainingTop, remainingBottom,
        alphaTopDeg, alphaBottomDeg,
        mode, cutMode, tiltDirTop, tiltDirBottom
      });
      renderFront({
        b, sz, s, angDeg,
        deltaTop, deltaBottom,
        cutMode,
        alphaTopDeg, alphaBottomDeg,
        tiltDirTop, tiltDirBottom
      });
      updateModeLabel();
    }

    function updateModeLabel() {
      if (!$modeLabel) return;
      if (mode === 'angle') {
        $modeLabel.textContent = 'وضع الحساب: من الزاوية → القص (يتم توزيع القص حسب اختيار الأجنحة)';
      } else {
        $modeLabel.textContent = 'وضع الحساب: من القص → الزاوية (حسب Δ العلوي والسفلي التي أدخلتها)';
      }
    }

    function renderReadout({
      s, sz, b, angDeg,
      deltaTop, deltaBottom,
      angleTopDeg, angleBottomDeg,
      remainingTop, remainingBottom,
      alphaTopDeg, alphaBottomDeg,
      mode, cutMode, tiltDirTop, tiltDirBottom
    }) {
      const avgAngle = (angleTopDeg + angleBottomDeg) / 2 || 0;
      const cutModeText =
        cutMode === 'both'   ? 'الجناحان (علوي + سفلي)' :
        cutMode === 'top'    ? 'الجناح العلوي فقط' :
                               'الجناح السفلي فقط';

      $readout.innerHTML = `
        <div class="text-sky-300 text-xs mb-1">ملخص الحساب</div>
        <div class="grid grid-cols-2 gap-x-3 gap-y-1">
          <div>البروفايل:</div><div class="text-right"><b>${s} ${sz}</b></div>
          <div>عرض الجناح b (تقريبي):</div><div class="text-right"><b>${b.toFixed(0)} mm</b></div>
          <div>الأجنحة التي يتم قصّها:</div><div class="text-right"><b>${cutModeText}</b></div>
          <div>زاوية الإدخال/الناتجة θ (متوسطة):</div><div class="text-right"><b>${angDeg.toFixed(2)}°</b></div>
          <div>قص الجناح العلوي لكل قطعة (Δ<sub>top</sub>):</div><div class="text-right text-emerald-300"><b>${deltaTop.toFixed(2)} mm</b></div>
          <div>قص الجناح السفلي لكل قطعة (Δ<sub>bottom</sub>):</div><div class="text-right text-emerald-300"><b>${deltaBottom.toFixed(2)} mm</b></div>
          <div>العرض المتبقي في الجناح العلوي بعد القص:</div><div class="text-right text-amber-300"><b>${remainingTop.toFixed(2)} mm</b></div>
          <div>العرض المتبقي في الجناح السفلي بعد القص:</div><div class="text-right text-amber-300"><b>${remainingBottom.toFixed(2)} mm</b></div>
          <div>زاوية تقريبية من القص العلوي (حسابية):</div><div class="text-right"><b>${angleTopDeg.toFixed(2)}°</b></div>
          <div>زاوية تقريبية من القص السفلي (حسابية):</div><div class="text-right"><b>${angleBottomDeg.toFixed(2)}°</b></div>
          <div>زاوية متوسطة بين العلوي والسفلي:</div><div class="text-right text-sky-300"><b>${avgAngle.toFixed(2)}°</b></div>
          <div>زاوية ميلان الخط العلوي في الرسم (α<sub>top</sub>):</div><div class="text-right"><b>${alphaTopDeg.toFixed(0)}°</b></div>
          <div>زاوية ميلان الخط السفلي في الرسم (α<sub>bottom</sub>):</div><div class="text-right"><b>${alphaBottomDeg.toFixed(0)}°</b></div>
          <div>اتجاه ميلان العلوي:</div><div class="text-right"><b>${tiltDirTop === 'in' ? 'نحو الوسط' : 'خارج'}</b></div>
          <div>اتجاه ميلان السفلي:</div><div class="text-right"><b>${tiltDirBottom === 'in' ? 'نحو الوسط' : 'خارج'}</b></div>
        </div>
        <div class="text-[10px] text-slate-400 mt-2">
          الزوايا α<sub>top</sub> و α<sub>bottom</sub> + اتجاهيهما المستقل يتحكم فقط في <b>شكل الخط الأحمر في الرسم</b> ولا يغيّر الحسابات الهندسية للقص.
        </div>
      `;
    }

    function renderFront({
      b, sz, s, angDeg,
      deltaTop, deltaBottom, cutMode,
      alphaTopDeg, alphaBottomDeg,
      tiltDirTop, tiltDirBottom
    }) {
      const widthPx  = 320;
      const heightPx = 260;
      const paddingY = 30;
      const midX   = widthPx / 2;
      const topY   = paddingY;
      const botY   = heightPx - paddingY;
      const nominalH = sz;
      const normH    = 200;
      const scaleH   = Math.min(1.1, Math.max(0.7, nominalH / 220));
      const profileHeight = normH * scaleH;
      const centerY = (topY + botY) / 2;
      const topFlangeY = centerY - profileHeight / 2;
      const botFlangeY = centerY + profileHeight / 2;
      const flangeTh = Math.max(18, Math.min(32, profileHeight * 0.18));
      const webTh    = Math.max(12, Math.min(26, profileHeight * 0.12));
      const halfFlangeSpan = 70 + (b - 180) * 0.25;
      const flangeLeftInner  = midX - halfFlangeSpan;
      const flangeRightInner = midX + halfFlangeSpan;
      const flangeWidthPx = flangeRightInner - flangeLeftInner;

      let fracTop = b > 0 ? deltaTop / b : 0;
      let fracBottom = b > 0 ? deltaBottom / b : 0;
      fracTop = Math.max(0, Math.min(0.5, fracTop));
      fracBottom = Math.max(0, Math.min(0.5, fracBottom));
      const cutXTop = flangeRightInner - fracTop * flangeWidthPx;
      const cutXBottom = flangeRightInner - fracBottom * flangeWidthPx;
      const showTopLine = (cutMode === 'both' || cutMode === 'top') && deltaTop > 0.0001;
      const showBottomLine = (cutMode === 'both' || cutMode === 'bottom') && deltaBottom > 0.0001;

      const phiTopRad = alphaTopDeg * Math.PI / 180;
      const phiBottomRad = alphaBottomDeg * Math.PI / 180;
      const dirSignTop = tiltDirTop === 'in' ? -1 : 1;
      const dirSignBottom = tiltDirBottom === 'in' ? -1 : 1;
      const dxTopTilt = Math.tan(phiTopRad) * flangeTh * dirSignTop;
      const dxBottomTilt = Math.tan(phiBottomRad) * flangeTh * dirSignBottom;

      const svg = `
        <svg width="${widthPx}" height="${heightPx}" viewBox="0 0 ${widthPx} ${heightPx}">
          <defs>
            <linearGradient id="metalGrad" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" stop-color="#cbd5f5"/><stop offset="40%" stop-color="#e5e7eb"/>
              <stop offset="70%" stop-color="#9ca3af"/><stop offset="100%" stop-color="#6b7280"/>
            </linearGradient>
            <linearGradient id="webGrad" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" stop-color="#e5e7eb"/><stop offset="100%" stop-color="#9ca3af"/>
            </linearGradient>
            <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
              <feDropShadow dx="0" dy="6" stdDeviation="6" flood-color="#020617" flood-opacity="0.8"/>
            </filter>
          </defs>
          <g filter="url(#shadow)">
            <rect x="${flangeLeftInner}" y="${topFlangeY}" width="${flangeWidthPx}" height="${flangeTh}" fill="url(#metalGrad)" stroke="#94a3b8" stroke-width="1"/>
            <rect x="${flangeLeftInner}" y="${botFlangeY - flangeTh}" width="${flangeWidthPx}" height="${flangeTh}" fill="url(#metalGrad)" stroke="#94a3b8" stroke-width="1"/>
            <rect x="${midX - webTh/2}" y="${topFlangeY + flangeTh}" width="${webTh}" height="${(botFlangeY - flangeTh) - (topFlangeY + flangeTh)}" fill="url(#webGrad)" stroke="#94a3b8" stroke-width="1"/>
          </g>
          ${showTopLine ? `
            <line x1="${cutXTop}" y1="${topFlangeY}" x2="${cutXTop + dxTopTilt}" y2="${topFlangeY + flangeTh}" stroke="#f97373" stroke-width="4" stroke-linecap="round"/>
          ` : ''}
          ${showBottomLine ? `
            <line x1="${cutXBottom}" y1="${botFlangeY - flangeTh}" x2="${cutXBottom + dxBottomTilt}" y2="${botFlangeY}" stroke="#f97373" stroke-width="4" stroke-linecap="round"/>
          ` : ''}
          <text x="${midX}" y="${topFlangeY - 12}" font-size="13" fill="#e5e7eb" text-anchor="middle" font-weight="600">${s} ${sz}</text>
          <text x="${midX}" y="${botFlangeY + 18}" font-size="11" fill="#fda4af" text-anchor="middle" font-weight="600">θ ≈ ${angDeg.toFixed(1)}°</text>
          <text x="${midX}" y="${botFlangeY + 34}" font-size="10" fill="#cbd5f5" text-anchor="middle">شكل واتجاه الخطوط الحمراء تمثيل تقريبي لوجه القص في الأجنحة المختارة.</text>
        </svg>
      `;
      $frontWrapper.innerHTML = svg;
    }

    [$series, $size].forEach(el => el.addEventListener('input', () => { mode='angle'; calc(); }));
    $angle.addEventListener('input', () => { mode = 'angle'; calc(); });
    $angleRange.addEventListener('input', () => { mode = 'angle'; $angle.value = $angleRange.value; calc(); });

    $deltaTop.addEventListener('input', () => { mode = 'cuts'; calc(); });
    $deltaBottom.addEventListener('input', () => { mode = 'cuts'; calc(); });
    $deltaTopRange.addEventListener('input', () => {
      mode = 'cuts';
      $deltaTop.value = $deltaTopRange.value;
      calc();
    });
    $deltaBottomRange.addEventListener('input', () => {
      mode = 'cuts';
      $deltaBottom.value = $deltaBottomRange.value;
      calc();
    });

    $alphaTop.addEventListener('input', () => calc());
    $alphaTopRange.addEventListener('input', () => { $alphaTop.value = $alphaTopRange.value; calc(); });
    $alphaBottom.addEventListener('input', () => calc());
    $alphaBottomRange.addEventListener('input', () => { $alphaBottom.value = $alphaBottomRange.value; calc(); });

    $cutWingsRadios.forEach(r => r.addEventListener('change', () => { mode = 'angle'; calc(); }));
    document.querySelectorAll('input[name="tiltDirTop"], input[name="tiltDirBottom"]').forEach(r => r.addEventListener('change', () => calc()));

    $btnReset.addEventListener('click', () => {
      mode = 'angle';
      $series.value = 'HEB';
      populateSizes();
      $size.value = '180';
      $angle.value = 30;
      $angleRange.value = 30;
      $deltaTop.value = 0;
      $deltaBottom.value = 0;
      $deltaTopRange.value = 0;
      $deltaBottomRange.value = 0;
      $alphaTop.value = 0;
      $alphaTopRange.value = 0;
      $alphaBottom.value = 0;
      $alphaBottomRange.value = 0;
      document.querySelector('input[name="cutWings"][value="both"]').checked = true;
      document.querySelector('input[name="tiltDirTop"][value="in"]').checked = true;
      document.querySelector('input[name="tiltDirBottom"][value="in"]').checked = true;
      calc();
    });

    populateSizes();
    document.getElementById('size').value = '180';
    calc();
  </script>
</body>
</html>
